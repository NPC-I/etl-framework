name: Security Audit

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'setup.py'
      - 'requirements*.txt'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'setup.py'
      - 'requirements*.txt'
  schedule:
    # Weekly security audit (Monday at 6 AM UTC)
    - cron: '0 6 * * 1'
  workflow_dispatch:  # Manual trigger

jobs:
  security-audit:
    name: Comprehensive Security Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[all]
        pip install bandit safety pytest pytest-cov tomli cyclonedx-bom

    - name: Run Bandit SAST
      run: |
        bandit -r src -f json -o bandit-report.json -ll || true
        echo "Bandit report generated"

    - name: Run Safety dependency check
      run: |
        safety check --json > safety-report.json || true
        echo "Safety report generated"

    - name: Run comprehensive security audit
      run: |
        python scripts/security_audit.py --skip-tests
        echo "Comprehensive security audit completed"

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ matrix.python-version }}
        path: |
          bandit-report.json
          safety-report.json
          security_audit_reports/
        retention-days: 30

    - name: Check for critical vulnerabilities
      run: |
        # Check if safety found critical vulnerabilities
        if [ -f safety-report.json ]; then
          VULN_COUNT=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "Found $VULN_COUNT vulnerabilities"
            jq '.vulnerabilities[] | "\(.package_name) \(.vulnerable_spec) - \(.advisory)"' safety-report.json
            if [ "$VULN_COUNT" -gt 5 ]; then
              echo "::error::Too many vulnerabilities found ($VULN_COUNT)"
              exit 1
            fi
          else
            echo "No vulnerabilities found"
          fi
        fi

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: security-audit
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install SBOM tools
      run: |
        pip install cyclonedx-bom

    - name: Generate SBOM
      run: |
        cyclonedx-py -e -i pyproject.toml -o sbom.json
        echo "SBOM generated"

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.json
        retention-days: 90

    - name: Upload to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: sbom.json

  security-gates:
    name: Security Gates
    runs-on: ubuntu-latest
    needs: [security-audit, sbom-generation]
    if: always()

    steps:
    - name: Download security reports
      uses: actions/download-artifact@v4
      with:
        name: security-reports-3.12
        path: ./reports

    - name: Evaluate security gates
      run: |
        echo "ðŸ”’ Security Gates Evaluation"
        echo "============================"
        
        # Check Bandit results
        if [ -f ./reports/bandit-report.json ]; then
          BANDIT_ISSUES=$(jq '.results | length' ./reports/bandit-report.json 2>/dev/null || echo "0")
          echo "Bandit Issues: $BANDIT_ISSUES"
          
          if [ "$BANDIT_ISSUES" -gt 10 ]; then
            echo "::error::Too many Bandit issues ($BANDIT_ISSUES)"
            exit 1
          fi
        fi
        
        # Check Safety results
        if [ -f ./reports/safety-report.json ]; then
          SAFETY_ISSUES=$(jq '.vulnerabilities | length' ./reports/safety-report.json 2>/dev/null || echo "0")
          echo "Safety Issues: $SAFETY_ISSUES"
          
          if [ "$SAFETY_ISSUES" -gt 0 ]; then
            echo "::warning::Found $SAFETY_ISSUES dependency vulnerabilities"
            # Don't fail for warnings, only for critical
          fi
        fi
        
        # Check comprehensive audit
        if [ -d ./reports/security_audit_reports ]; then
          LATEST_REPORT=$(find ./reports/security_audit_reports -name "*comprehensive_security_audit_report.json" -type f | sort -r | head -1)
          if [ -n "$LATEST_REPORT" ]; then
            SCORE=$(jq '.summary.security_score' "$LATEST_REPORT" 2>/dev/null || echo "0")
            echo "Security Score: $SCORE/100"
            
            if (( $(echo "$SCORE < 70" | bc -l) )); then
              echo "::error::Security score below threshold (70)"
              exit 1
            fi
          fi
        fi
        
        echo "âœ… All security gates passed"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [security-audit, security-gates]
    if: failure() && github.event_name != 'schedule'
    
    steps:
    - name: Send notification
      run: |
        echo "Security audit failed! Check the workflow run for details."
        # In a real setup, you would integrate with Slack, Teams, or email
        # Example: curl -X POST -H 'Content-type: application/json' --data '{"text":"Security audit failed!"}' $SLACK_WEBHOOK_URL